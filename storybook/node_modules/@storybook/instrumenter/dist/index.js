var B=Object.create;var b=Object.defineProperty;var M=Object.getOwnPropertyDescriptor;var Y=Object.getOwnPropertyNames;var G=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var K=(f,s)=>{for(var t in s)b(f,t,{get:s[t],enumerable:!0})},N=(f,s,t,d)=>{if(s&&typeof s=="object"||typeof s=="function")for(let r of Y(s))!F.call(f,r)&&r!==t&&b(f,r,{get:()=>s[r],enumerable:!(d=M(s,r))||d.enumerable});return f};var V=(f,s,t)=>(t=f!=null?B(G(f)):{},N(s||!f||!f.__esModule?b(t,"default",{value:f,enumerable:!0}):t,f)),W=f=>N(b({},"__esModule",{value:!0}),f);var $={};K($,{CallStates:()=>w,EVENTS:()=>S,instrument:()=>U});module.exports=W($);var P=require("@storybook/addons"),R=require("@storybook/client-logger"),m=require("@storybook/core-events"),_=V(require("global"));var w=(r=>(r.DONE="done",r.ERROR="error",r.ACTIVE="active",r.WAITING="waiting",r))(w||{});var S={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},k,L=((k=_.default.FEATURES)==null?void 0:k.interactionsDebugger)!==!0,A={debugger:!L,start:!1,back:!1,goto:!1,next:!1,end:!1},x=new Error("This function ran after the play function completed. Did you forget to `await` it?"),j=f=>Object.prototype.toString.call(f)==="[object Object]",z=f=>Object.prototype.toString.call(f)==="[object Module]",H=f=>{if(!j(f)&&!z(f))return!1;if(f.constructor===void 0)return!0;let s=f.constructor.prototype;return!(!j(s)||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)},X=f=>{try{return new f.constructor}catch{return{}}},T=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),D=(f,s=!1)=>{let t=(s?f.shadowCalls:f.calls).filter(r=>r.retain);if(!t.length)return;let d=new Map(Array.from(f.callRefsByResult.entries()).filter(([,r])=>r.retain));return{cursor:t.length,calls:t,callRefsByResult:d}},C=class{constructor(){this.initialized=!1;this.channel=P.addons.getChannel(),this.state=_.default.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let s=({storyId:n,isPlaying:o=!0,isDebugging:e=!1})=>{let c=this.getState(n);this.setState(n,{...T(),...D(c,e),shadowCalls:e?c.shadowCalls:[],chainedCallIds:e?c.chainedCallIds:new Set,playUntil:e?c.playUntil:void 0,isPlaying:o,isDebugging:e}),this.sync(n)};this.channel.on(m.FORCE_REMOUNT,s),this.channel.on(m.STORY_RENDER_PHASE_CHANGED,({storyId:n,newPhase:o})=>{let{isDebugging:e}=this.getState(n);this.setState(n,{renderPhase:o}),o==="preparing"&&e&&s({storyId:n}),o==="playing"&&s({storyId:n,isDebugging:e}),o==="played"&&this.setState(n,{isLocked:!1,isPlaying:!1,isDebugging:!1}),o==="errored"&&this.setState(n,{isLocked:!1,isPlaying:!1})}),this.channel.on(m.SET_CURRENT_STORY,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=({storyId:n,playUntil:o})=>{this.getState(n).isDebugging||this.setState(n,({calls:c})=>({calls:[],shadowCalls:c.map(u=>({...u,status:"waiting"})),isDebugging:!0}));let e=this.getLog(n);this.setState(n,({shadowCalls:c})=>{var a;if(o||!e.length)return{playUntil:o};let u=c.findIndex(h=>h.id===e[0].callId);return{playUntil:(a=c.slice(0,u).filter(h=>h.interceptable&&!h.ancestors.length).slice(-1)[0])==null?void 0:a.id}}),this.channel.emit(m.FORCE_REMOUNT,{storyId:n,isDebugging:!0})},d=({storyId:n})=>{var c;let o=this.getLog(n).filter(u=>!u.ancestors.length),e=o.reduceRight((u,a,h)=>u>=0||a.status==="waiting"?u:h,-1);t({storyId:n,playUntil:(c=o[e-1])==null?void 0:c.callId})},r=({storyId:n,callId:o})=>{var p;let{calls:e,shadowCalls:c,resolvers:u}=this.getState(n),a=e.find(({id:g})=>g===o),h=c.find(({id:g})=>g===o);if(!a&&h&&Object.values(u).length>0){let g=(p=this.getLog(n).find(y=>y.status==="waiting"))==null?void 0:p.callId;h.id!==g&&this.setState(n,{playUntil:h.id}),Object.values(u).forEach(y=>y())}else t({storyId:n,playUntil:o})},i=({storyId:n})=>{var e;let{resolvers:o}=this.getState(n);if(Object.values(o).length>0)Object.values(o).forEach(c=>c());else{let c=(e=this.getLog(n).find(u=>u.status==="waiting"))==null?void 0:e.callId;c?t({storyId:n,playUntil:c}):l({storyId:n})}},l=({storyId:n})=>{this.setState(n,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(n).resolvers).forEach(o=>o())};this.channel.on(S.START,t),this.channel.on(S.BACK,d),this.channel.on(S.GOTO,r),this.channel.on(S.NEXT,i),this.channel.on(S.END,l)}getState(s){return this.state[s]||T()}setState(s,t){let d=this.getState(s),r=typeof t=="function"?t(d):t;this.state={...this.state,[s]:{...d,...r}},_.default.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[d,r])=>{let i=D(r);return i&&(t[d]=Object.assign(T(),i)),t},{});let s={controlStates:A,logItems:[]};this.channel.emit(S.SYNC,s),_.default.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(s){let{calls:t,shadowCalls:d}=this.getState(s),r=[...d];t.forEach((l,n)=>{r[n]=l});let i=new Set;return r.reduceRight((l,n)=>(n.args.forEach(o=>{o!=null&&o.__callId__&&i.add(o.__callId__)}),n.path.forEach(o=>{o.__callId__&&i.add(o.__callId__)}),(n.interceptable||n.exception)&&!i.has(n.id)&&(l.unshift({callId:n.id,status:n.status,ancestors:n.ancestors}),i.add(n.id)),l),[])}instrument(s,t){if(!H(s))return s;let{mutate:d=!1,path:r=[]}=t;return Object.keys(s).reduce((i,l)=>{let n=s[l];return typeof n!="function"?(i[l]=this.instrument(n,{...t,path:r.concat(l)}),i):typeof n.__originalFn__=="function"?(i[l]=n,i):(i[l]=(...o)=>this.track(l,n,o,t),i[l].__originalFn__=n,Object.defineProperty(i[l],"name",{value:l,writable:!1}),Object.keys(n).length>0&&Object.assign(i[l],this.instrument({...n},{...t,path:r.concat(l)})),i)},d?s:X(s))}track(s,t,d,r){var y,O,I,E;let i=((y=d==null?void 0:d[0])==null?void 0:y.__storyId__)||((E=(I=(O=_.default.window.__STORYBOOK_PREVIEW__)==null?void 0:O.urlStore)==null?void 0:I.selection)==null?void 0:E.storyId),{cursor:l,ancestors:n}=this.getState(i);this.setState(i,{cursor:l+1});let o=`${n.slice(-1)[0]||i} [${l}] ${s}`,{path:e=[],intercept:c=!1,retain:u=!1}=r,a=typeof c=="function"?c(s,e):c,h={id:o,cursor:l,storyId:i,ancestors:n,path:e,method:s,args:d,interceptable:a,retain:u},g=(a&&!n.length?this.intercept:this.invoke).call(this,t,h,r);return this.instrument(g,{...r,mutate:!0,path:[{__callId__:h.id}]})}intercept(s,t,d){let{chainedCallIds:r,isDebugging:i,playUntil:l}=this.getState(t.storyId),n=r.has(t.id);return!i||n||l?(l===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(s,t,d)):new Promise(o=>{this.setState(t.storyId,({resolvers:e})=>({isLocked:!1,resolvers:{...e,[t.id]:o}}))}).then(()=>(this.setState(t.storyId,o=>{let{[t.id]:e,...c}=o.resolvers;return{isLocked:!0,resolvers:c}}),this.invoke(s,t,d)))}invoke(s,t,d){let{callRefsByResult:r,renderPhase:i}=this.getState(t.storyId),l=e=>{var c,u;if(r.has(e))return r.get(e);if(e instanceof Array)return e.map(l);if(e instanceof Date)return{__date__:{value:e.toISOString()}};if(e instanceof Error){let{name:a,message:h,stack:p}=e;return{__error__:{name:a,message:h,stack:p}}}if(e instanceof RegExp){let{flags:a,source:h}=e;return{__regexp__:{flags:a,source:h}}}if(e instanceof _.default.window.HTMLElement){let{prefix:a,localName:h,id:p,classList:g,innerText:y}=e,O=Array.from(g);return{__element__:{prefix:a,localName:h,id:p,classNames:O,innerText:y}}}return typeof e=="function"?{__function__:{name:e.name}}:typeof e=="symbol"?{__symbol__:{description:e.description}}:typeof e=="object"&&((c=e==null?void 0:e.constructor)==null?void 0:c.name)&&((u=e==null?void 0:e.constructor)==null?void 0:u.name)!=="Object"?{__class__:{name:e.constructor.name}}:Object.prototype.toString.call(e)==="[object Object]"?Object.fromEntries(Object.entries(e).map(([a,h])=>[a,l(h)])):e},n={...t,args:t.args.map(l)};t.path.forEach(e=>{e!=null&&e.__callId__&&this.setState(t.storyId,({chainedCallIds:c})=>({chainedCallIds:new Set(Array.from(c).concat(e.__callId__))}))});let o=e=>{if(e instanceof Error){let{name:c,message:u,stack:a,callId:h=t.id}=e,p={name:c,message:u,stack:a,callId:h};if(this.update({...n,status:"error",exception:p}),this.setState(t.storyId,g=>({callRefsByResult:new Map([...Array.from(g.callRefsByResult.entries()),[e,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(e,"callId")||Object.defineProperty(e,"callId",{value:t.id}),e;if(e!==x)throw R.logger.warn(e),m.IGNORED_EXCEPTION}throw e};try{if(i==="played"&&!t.retain)throw x;let c=(d.getArgs?d.getArgs(t,this.getState(t.storyId)):t.args).map(a=>typeof a!="function"||Object.keys(a).length?a:(...h)=>{let{cursor:p,ancestors:g}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[...g,t.id]});let y=()=>this.setState(t.storyId,{cursor:p,ancestors:g}),O=!1;try{let I=a(...h);return I instanceof Promise?(O=!0,I.finally(y)):I}finally{O||y()}}),u=s(...c);return u&&["object","function","symbol"].includes(typeof u)&&this.setState(t.storyId,a=>({callRefsByResult:new Map([...Array.from(a.callRefsByResult.entries()),[u,{__callId__:t.id,retain:t.retain}]])})),this.update({...n,status:u instanceof Promise?"active":"done"}),u instanceof Promise?u.then(a=>(this.update({...n,status:"done"}),a),o):u}catch(e){return o(e)}}update(s){this.channel.emit(S.CALL,s),this.setState(s.storyId,({calls:t})=>{let d=t.concat(s).reduce((r,i)=>Object.assign(r,{[i.id]:i}),{});return{calls:Object.values(d).sort((r,i)=>r.id.localeCompare(i.id,void 0,{numeric:!0}))}}),this.sync(s.storyId)}sync(s){let t=()=>{var u;let{isLocked:d,isPlaying:r}=this.getState(s),i=this.getLog(s),l=(u=i.filter(({ancestors:a})=>!a.length).find(a=>a.status==="waiting"))==null?void 0:u.callId,n=i.some(a=>a.status==="active");if(L||d||n||i.length===0){let a={controlStates:A,logItems:i};this.channel.emit(S.SYNC,a);return}let o=i.some(a=>["done","error"].includes(a.status)),c={controlStates:{debugger:!0,start:o,back:o,goto:!0,next:r,end:r},logItems:i,pausedAt:l};this.channel.emit(S.SYNC,c)};this.setState(s,({syncTimeout:d})=>(clearTimeout(d),{syncTimeout:setTimeout(t,0)}))}};function U(f,s={}){var t,d,r,i;try{let l=!1,n=!1;return(d=(t=_.default.window.location)==null?void 0:t.search)!=null&&d.includes("instrument=true")?l=!0:(i=(r=_.default.window.location)==null?void 0:r.search)!=null&&i.includes("instrument=false")&&(n=!0),_.default.window.parent===_.default.window&&!l||n?f:(_.default.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(_.default.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new C),_.default.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(f,s))}catch(l){return R.once.warn(l),f}}0&&(module.exports={CallStates,EVENTS,instrument});
