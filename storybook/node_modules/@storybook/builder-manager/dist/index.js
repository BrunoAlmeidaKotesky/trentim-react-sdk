"use strict";var X=Object.create;var b=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var ee=Object.getPrototypeOf,te=Object.prototype.hasOwnProperty;var re=(e,t)=>{for(var r in t)b(e,r,{get:t[r],enumerable:!0})},I=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Z(t))!te.call(e,i)&&i!==r&&b(e,i,{get:()=>t[i],enumerable:!(s=Y(t,i))||s.enumerable});return e};var n=(e,t,r)=>(r=e!=null?X(ee(e)):{},I(t||!e||!e.__esModule?b(r,"default",{value:e,enumerable:!0}):r,e)),se=e=>I(b({},"__esModule",{value:!0}),e);var me={};re(me,{bail:()=>Q,build:()=>le,corePresets:()=>ce,executor:()=>J,getConfig:()=>M,overridePresets:()=>ue,start:()=>ae});module.exports=se(me);var a=require("path"),E=n(require("fs-extra")),_=n(require("express")),y=require("@storybook/node-logger"),$=require("@fal-works/esbuild-plugin-global-externals"),z=require("@yarnpkg/esbuild-plugin-pnp"),K=n(require("esbuild-plugin-alias"));var R=n(require("path")),B=n(require("fs-extra")),A=require("ejs");var N=async e=>(0,R.join)((0,R.dirname)(require.resolve("@storybook/builder-manager/package.json")),"templates",e),U=async e=>{let t=await N(e);return B.default.readFile(t,"utf8")};var T=async(e,t,r,s,i,o,c,u,m,{versionCheck:p,releaseNotesData:O,docsMode:F,previewUrl:h,serverChannelUrl:d})=>{let f=await r,g=await t,x=await e;return(0,A.render)(x,{title:g?`${g} - Storybook`:"Storybook",files:{js:i,css:s},globals:{FEATURES:JSON.stringify(await o,null,2),REFS:JSON.stringify(await c,null,2),LOGLEVEL:JSON.stringify(await u,null,2),DOCS_OPTIONS:JSON.stringify(await m,null,2),VERSIONCHECK:JSON.stringify(JSON.stringify(p),null,2),RELEASE_NOTES_DATA:JSON.stringify(JSON.stringify(O),null,2),PREVIEW_URL:JSON.stringify(h,null,2),SERVER_CHANNEL_URL:JSON.stringify(d,null,2)},head:f?await B.default.readFile(f,"utf8"):""})};var C=require("@storybook/manager/dist/globals");var V=require("path"),k=require("@storybook/core-common");var P=e=>{try{return Promise.resolve(require.resolve(e))}catch{return Promise.resolve(!1)}};var L=async e=>{let t=(0,k.getRefs)(e),r=e.presets.apply("features"),s=e.presets.apply("logLevel"),i=e.presets.apply("title"),o=e.presets.apply("docs",{}),c=U("template.ejs"),u=P((0,V.join)(e.configDir,"manager-head.html")),[m,p]=await Promise.all([J.get(),M(e)]);return{refs:t,features:r,title:i,docsOptions:o,template:c,customHead:u,instance:m,config:p,logLevel:s}};var H=n(require("fs-extra")),G=require("path"),W=n(require("slash"));async function q(e,t){let r=await Promise.all((t==null?void 0:t.map(async o=>{let{location:c,url:u}=ie(o,e);return await H.default.ensureFile(c),await H.default.writeFile(c,o.contents),u}))||[]),s=r.filter(o=>o.endsWith(".mjs"));return{cssFiles:r.filter(o=>o.endsWith(".css")),jsFiles:s}}function ie(e,t){let r=e.path.replace(t,""),s=(0,G.join)(t,r),i=`./sb-addons${(0,W.default)(r).split("/").map(encodeURIComponent).join("/")}`;return{location:s,url:i}}var l,w,M=async e=>{let[t,r,s]=await Promise.all([e.presets.apply("managerEntries",[]),P((0,a.join)(e.configDir,"manager")),N("addon.tsconfig.json")]);return{entryPoints:r?[...t,r]:t,outdir:(0,a.join)(e.outputDir||"./","sb-addons"),format:"esm",write:!1,outExtension:{".js":".mjs"},loader:{".js":"jsx",".png":"dataurl",".gif":"dataurl",".jpg":"dataurl",".jpeg":"dataurl",".svg":"dataurl",".webp":"dataurl",".webm":"dataurl"},target:["chrome100"],platform:"browser",bundle:!0,minify:!1,sourcemap:!0,jsxFactory:"React.createElement",jsxFragment:"React.Fragment",jsx:"transform",jsxImportSource:"react",tsconfig:s,legalComments:"external",plugins:[(0,K.default)({process:require.resolve("process/browser.js"),util:require.resolve("util/util.js"),assert:require.resolve("browser-assert")}),(0,$.globalExternals)(C.definitions),(0,z.pnpPlugin)()],define:{"process.env.NODE_ENV":"'production'","process.env":"{}",global:"window",module:"{}"}}},J={get:async()=>{let{build:e}=await import("esbuild");return e}},oe=async function*({startTime:t,options:r,router:s}){y.logger.info("=> Starting manager..");let{config:i,customHead:o,features:c,instance:u,refs:m,template:p,title:O,logLevel:F,docsOptions:h}=await L(r);yield;let d=i.outdir;await E.default.remove(d),yield,l=await u({...i,watch:!0}),yield;let f=(0,a.join)((0,a.dirname)(require.resolve("@storybook/manager/package.json")),"dist");s.use("/sb-addons",_.default.static(d)),s.use("/sb-manager",_.default.static(f));let{cssFiles:g,jsFiles:x}=await q(d,l==null?void 0:l.outputFiles);yield;let v=await T(p,O,o,g,x,c,m,F,h,r);return yield,s.use("/",({path:j},D,S)=>{j==="/"?D.status(200).send(v):S()}),{bail:Q,stats:{toJson:()=>({})},totalTime:process.hrtime(t)}},ne=async function*({startTime:t,options:r}){if(!r.outputDir)throw new Error("outputDir is required");y.logger.info("=> Building manager..");let{config:s,customHead:i,features:o,instance:c,refs:u,template:m,title:p,logLevel:O,docsOptions:F}=await L(r);yield;let h=s.outdir,d=(0,a.join)((0,a.dirname)(require.resolve("@storybook/manager/package.json")),"dist"),f=(0,a.join)(r.outputDir,"sb-manager");l=await c({...s,minify:!0,watch:!1}),yield;let g=E.default.copy(d,f,{filter:D=>{let{ext:S}=(0,a.parse)(D);return S?S===".mjs":!0}}),{cssFiles:x,jsFiles:v}=await q(h,l==null?void 0:l.outputFiles);yield;let j=await T(m,p,i,x,v,o,u,O,F,r);return await Promise.all([E.default.writeFile((0,a.join)(r.outputDir,"index.html"),j),g]),y.logger.trace({message:"=> Manager built",time:process.hrtime(t)}),{toJson:()=>({})}},Q=async()=>{if(w)try{await w.throw(new Error)}catch{}if(l&&l.stop)try{l.stop(),y.logger.warn("Force closed manager build")}catch{y.logger.warn("Unable to close manager build!")}},ae=async e=>{w=oe(e);let t;do t=await w.next();while(!t.done);return t.value},le=async e=>{w=ne(e);let t;do t=await w.next();while(!t.done);return t.value},ce=[],ue=[];0&&(module.exports={bail,build,corePresets,executor,getConfig,overridePresets,start});
