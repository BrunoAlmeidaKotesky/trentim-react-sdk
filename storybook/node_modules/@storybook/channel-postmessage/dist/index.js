var N=Object.create;var h=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var M=Object.getPrototypeOf,j=Object.prototype.hasOwnProperty;var P=(n,e)=>{for(var t in e)h(n,t,{get:e[t],enumerable:!0})},C=(n,e,t,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of D(e))!j.call(n,r)&&r!==t&&h(n,r,{get:()=>e[r],enumerable:!(a=q(e,r))||a.enumerable});return n};var y=(n,e,t)=>(t=n!=null?N(M(n)):{},C(e||!n||!n.__esModule?h(t,"default",{value:n,enumerable:!0}):t,n)),T=n=>C(h({},"__esModule",{value:!0}),n);var z={};P(z,{KEY:()=>w,PostmsgTransport:()=>v,createChannel:()=>$,default:()=>_});module.exports=T(z);var m=y(require("global")),U=y(require("@storybook/core-events")),F=require("@storybook/channels"),f=require("@storybook/client-logger"),p=require("telejson"),k=y(require("qs")),{window:o,document:c,location:b}=m.default,w="storybook-channel",R={allowFunction:!0,maxDepth:25},v=class{constructor(e){this.config=e;if(this.buffer=[],this.handler=null,o&&o.addEventListener("message",this.handleEvent.bind(this),!1),e.page!=="manager"&&e.page!=="preview")throw new Error(`postmsg-channel: "config.page" cannot be "${e.page}"`)}setHandler(e){this.handler=(...t)=>{e.apply(this,t),!this.connected&&this.getLocalFrame().length&&(this.flush(),this.connected=!0)}}send(e,t){let{target:a,allowRegExp:r,allowFunction:s,allowSymbol:i,allowDate:l,allowUndefined:u,allowClass:S,maxDepth:O,space:A,lazyEval:L}=t||{},H=Object.fromEntries(Object.entries({allowRegExp:r,allowFunction:s,allowSymbol:i,allowDate:l,allowUndefined:u,allowClass:S,maxDepth:O,space:A,lazyEval:L}).filter(([d,g])=>typeof g<"u")),I={...R,...m.default.CHANNEL_OPTIONS||{},...H},E=this.getFrames(a),W=k.default.parse(b.search,{ignoreQueryPrefix:!0}),x=(0,p.stringify)({key:w,event:e,refId:W.refId},I);return E.length?(this.buffer.length&&this.flush(),E.forEach(d=>{try{d.postMessage(x,"*")}catch{console.error("sending over postmessage fail")}}),Promise.resolve(null)):new Promise((d,g)=>{this.buffer.push({event:e,resolve:d,reject:g})})}flush(){let{buffer:e}=this;this.buffer=[],e.forEach(t=>{this.send(t.event).then(t.resolve).catch(t.reject)})}getFrames(e){if(this.config.page==="manager"){let a=[...c.querySelectorAll("iframe[data-is-storybook][data-is-loaded]")].filter(r=>{try{return!!r.contentWindow&&r.dataset.isStorybook!==void 0&&r.id===e}catch{return!1}}).map(r=>r.contentWindow);return a.length?a:this.getCurrentFrames()}return o&&o.parent&&o.parent!==o?[o.parent]:[]}getCurrentFrames(){return this.config.page==="manager"?[...c.querySelectorAll('[data-is-storybook="true"]')].map(t=>t.contentWindow):o&&o.parent?[o.parent]:[]}getLocalFrame(){return this.config.page==="manager"?[...c.querySelectorAll("#storybook-preview-iframe")].map(t=>t.contentWindow):o&&o.parent?[o.parent]:[]}handleEvent(e){try{let{data:t}=e,{key:a,event:r,refId:s}=typeof t=="string"&&(0,p.isJSON)(t)?(0,p.parse)(t,m.default.CHANNEL_OPTIONS||{}):t;if(a===w){let i=this.config.page==="manager"?'<span style="color: #37D5D3; background: black"> manager </span>':'<span style="color: #1EA7FD; background: black"> preview </span>',l=Object.values(U).includes(r.type)?`<span style="color: #FF4785">${r.type}</span>`:`<span style="color: #FFAE00">${r.type}</span>`;if(s&&(r.refId=s),r.source=this.config.page==="preview"?e.origin:B(e),!r.source){f.pretty.error(`${i} received ${l} but was unable to determine the source of the event`);return}let u=`${i} received ${l} (${t.length})`;f.pretty.debug(b.origin!==r.source?u:`${u} <span style="color: gray">(on ${b.origin} from ${r.source})</span>`,...r.args),this.handler(r)}}catch(t){f.logger.error(t)}}},B=n=>{let e=[...c.querySelectorAll("iframe[data-is-storybook]")],[t,...a]=e.filter(r=>{try{return r.contentWindow===n.source}catch{}let s=r.getAttribute("src"),i;try{({origin:i}=new URL(s,c.location))}catch{return!1}return i===n.origin});if(t&&a.length===0){let r=t.getAttribute("src"),{protocol:s,host:i,pathname:l}=new URL(r,c.location);return`${s}//${i}${l}`}return a.length>0&&f.logger.error("found multiple candidates for event source"),null};function $({page:n}){let e=new v({page:n});return new F.Channel({transport:e})}var _=$;0&&(module.exports={KEY,PostmsgTransport,createChannel});
