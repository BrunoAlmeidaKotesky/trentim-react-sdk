import{dedent as G}from"ts-dedent";import L from"global";import{logger as k}from"@storybook/client-logger";import{toId as z,sanitize as N}from"@storybook/csf";import{combineParameters as _,composeStepRunners as V,normalizeInputTypes as I}from"@storybook/store";import b from"global";import{dedent as R}from"ts-dedent";import{SynchronousPromise as O}from"synchronous-promise";import{toId as w,isExportStory as $,storyNameFromExport as v}from"@storybook/csf";import{userOrAutoTitle as M,sortStoriesV6 as C}from"@storybook/store";import{logger as D}from"@storybook/client-logger";var E=class{constructor(){this.projectAnnotations={loaders:[],decorators:[],parameters:{},argsEnhancers:[],argTypesEnhancers:[],args:{},argTypes:{}},this.entries={},this.csfExports={}}importFn(r){return O.resolve().then(()=>{let e=this.csfExports[r];if(!e)throw new Error(`Unknown path: ${r}`);return e})}getStoryIndex(r){let e=Object.keys(this.csfExports),p=this.projectAnnotations.parameters?.options?.storySort,u=Object.entries(this.entries).map(([s,{type:y,importPath:a,...d}])=>{let i=this.csfExports[a],f=r.processCSFFileWithCache(i,a,i.default.title),n;return y==="story"?n=r.storyFromCSFFile({storyId:s,csfFile:f}):n={...d,story:d.name,kind:d.title,componentId:w(d.componentId||d.title),parameters:{fileName:a}},[s,n,f.meta.parameters,this.projectAnnotations.parameters]}),m;try{m=C(u,p,e)}catch(s){throw typeof p=="function"?new Error(R`
          Error sorting stories with sort parameter ${p}:

          > ${s.message}
          
          Are you using a V7-style sort function in V6 compatibility mode?
          
          More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#v7-style-story-sort
        `):s}let o=m.reduce((s,y)=>(s[y.id]=this.entries[y.id],s),{});return{v:4,entries:o}}clearFilenameExports(r){!this.csfExports[r]||(Object.entries(this.entries).forEach(([e,{importPath:p}])=>{p===r&&delete this.entries[e]}),this.csfExports[r]={})}addStoriesFromExports(r,e){if(r.match(/\.mdx$/)&&!r.match(/\.stories\.mdx$/)||this.csfExports[r]===e)return;this.clearFilenameExports(r);let{default:p,__namedExportsOrder:l,...u}=e,{id:m,title:o,tags:s=[]}=p||{},y=(b.STORIES||[]).map(n=>({...n,importPathMatcher:new RegExp(n.importPathMatcher)}));if(o=M(r,y,o),!o){D.info(`Unexpected default export without title in '${r}': ${JSON.stringify(e.default)}`);return}this.csfExports[r]={...e,default:{...p,title:o}};let a=u;Array.isArray(l)&&(a={},l.forEach(n=>{let c=u[n];c&&(a[n]=c)}));let d=Object.entries(a).filter(([n])=>$(n,p)),i=b.DOCS_OPTIONS||{},f=i.docsPage==="automatic"||i.docsPage&&s.includes("docsPage");if(i.enabled&&d.length&&(s.includes("mdx")||f)){let n=i.defaultName,c=w(m||o,n);this.entries[c]={type:"docs",standalone:!1,id:c,title:o,name:n,importPath:r,...m&&{componentId:m},tags:[...s,"docs"],storiesImports:[]}}d.forEach(([n,c])=>{let A=v(n),S=c.parameters?.__id||w(m||o,A),x=typeof c!="function"&&c.name||c.storyName||c.story?.name||A;c.parameters?.docsOnly||(this.entries[S]={type:"story",id:S,name:x,title:o,importPath:r,...m&&{componentId:m},tags:[...c.tags||s,"story"]})})}};var h,Y={addDecorator:"Instead, use `export const decorators = [];` in your `preview.js`.",addParameters:"Instead, use `export const parameters = {};` in your `preview.js`.",addLoader:"Instead, use `export const loaders = [];` in your `preview.js`.",addArgs:"",addArgTypes:"",addArgsEnhancer:"",addArgTypesEnhancer:"",addStepRunner:"",getGlobalRender:"",setGlobalRender:""},g=t=>{if(L.FEATURES?.storyStoreV7)throw new Error(G`You cannot use \`${t}\` with the new Story Store.

      ${Y[t]}`);if(!h)throw new Error(`Singleton client API not yet initialized, cannot call \`${t}\`.`)},Q=t=>{g("addDecorator"),h.addDecorator(t)},U=t=>{g("addParameters"),h.addParameters(t)},B=t=>{g("addLoader"),h.addLoader(t)},H=t=>{g("addArgs"),h.addArgs(t)},J=t=>{g("addArgTypes"),h.addArgTypes(t)},W=t=>{g("addArgsEnhancer"),h.addArgsEnhancer(t)},q=t=>{g("addArgTypesEnhancer"),h.addArgTypesEnhancer(t)},K=t=>{g("addStepRunner"),h.addStepRunner(t)};var X=t=>{g("setGlobalRender"),h.facade.projectAnnotations.render=t},Z=new Set(["string","number","boolean","symbol"]),T=class{constructor({storyStore:r}={}){this.lastFileName=0;this.addDecorator=r=>{this.facade.projectAnnotations.decorators.push(r)};this.addParameters=({globals:r,globalTypes:e,...p})=>{this.facade.projectAnnotations.parameters=_(this.facade.projectAnnotations.parameters,p),r&&(this.facade.projectAnnotations.globals={...this.facade.projectAnnotations.globals,...r}),e&&(this.facade.projectAnnotations.globalTypes={...this.facade.projectAnnotations.globalTypes,...I(e)})};this.addStepRunner=r=>{this.facade.projectAnnotations.runStep=V([this.facade.projectAnnotations.runStep,r].filter(Boolean))};this.addLoader=r=>{this.facade.projectAnnotations.loaders.push(r)};this.addArgs=r=>{this.facade.projectAnnotations.args={...this.facade.projectAnnotations.args,...r}};this.addArgTypes=r=>{this.facade.projectAnnotations.argTypes={...this.facade.projectAnnotations.argTypes,...I(r)}};this.addArgsEnhancer=r=>{this.facade.projectAnnotations.argsEnhancers.push(r)};this.addArgTypesEnhancer=r=>{this.facade.projectAnnotations.argTypesEnhancers.push(r)};this._addedExports={};this.storiesOf=(r,e)=>{if(!r&&typeof r!="string")throw new Error("Invalid or missing kind provided for stories, should be a string");if(e||k.warn(`Missing 'module' parameter for story with a kind of '${r}'. It will break your HMR`),e){let a=Object.getPrototypeOf(e);a.exports&&a.exports.default&&k.error(`Illegal mix of CSF default export and storiesOf calls in a single file: ${a.i}`)}let p=e&&e.id?`${e.id}`:(this.lastFileName++).toString(),l=p,u=1;for(;this._addedExports[l];)u+=1,l=`${p}-${u}`;e&&e.hot&&e.hot.accept&&(e.hot.accept(),e.hot.dispose(()=>{this.facade.clearFilenameExports(l),delete this._addedExports[l],setTimeout(()=>{this._loadAddedExports(),this.onImportFnChanged?.({importFn:this.importFn.bind(this)})},0)}));let m=!1,o={kind:r.toString(),add:()=>o,addDecorator:()=>o,addLoader:()=>o,addParameters:()=>o};Object.keys(this.addons).forEach(a=>{let d=this.addons[a];o[a]=(...i)=>(d.apply(o,i),o)});let s={id:N(r),title:r,decorators:[],loaders:[],parameters:{}};this._addedExports[l]={default:s};let y=0;return o.add=(a,d,i={})=>{if(m=!0,typeof a!="string")throw new Error(`Invalid or missing storyName provided for a "${r}" story.`);if(!d||Array.isArray(d)||Z.has(typeof d))throw new Error(`Cannot load story "${a}" in "${r}" due to invalid format. Storybook expected a function/object but received ${typeof d} instead.`);let{decorators:f,loaders:n,component:c,args:A,argTypes:S,...x}=i,P=i.__id||z(r,a),j=this._addedExports[l];return j[`story${y}`]={name:a,parameters:{fileName:l,__id:P,...x},decorators:f,loaders:n,args:A,argTypes:S,component:c,render:d},y+=1,o},o.addDecorator=a=>{if(m)throw new Error(`You cannot add a decorator after the first story for a kind.
Read more here: https://github.com/storybookjs/storybook/blob/master/MIGRATION.md#can-no-longer-add-decoratorsparameters-after-stories`);return s.decorators.push(a),o},o.addLoader=a=>{if(m)throw new Error("You cannot add a loader after the first story for a kind.");return s.loaders.push(a),o},o.addParameters=({component:a,args:d,argTypes:i,tags:f,...n})=>{if(m)throw new Error(`You cannot add parameters after the first story for a kind.
Read more here: https://github.com/storybookjs/storybook/blob/master/MIGRATION.md#can-no-longer-add-decoratorsparameters-after-stories`);return s.parameters=_(s.parameters,n),a&&(s.component=a),d&&(s.args={...s.args,...d}),i&&(s.argTypes={...s.argTypes,...i}),f&&(s.tags=f),o},o};this.raw=()=>this.storyStore.raw();this.facade=new E,this.addons={},this.storyStore=r,h=this}importFn(r){return this.facade.importFn(r)}getStoryIndex(){if(!this.storyStore)throw new Error("Cannot get story index before setting storyStore");return this.facade.getStoryIndex(this.storyStore)}_loadAddedExports(){Object.entries(this._addedExports).forEach(([r,e])=>this.facade.addStoriesFromExports(r,e))}get _storyStore(){return this.storyStore}};export*from"@storybook/store";import rr from"global";import{parse as tr}from"qs";var er=()=>{let{document:t}=rr;return t&&t.location&&t.location.search?tr(t.location.search,{ignoreQueryPrefix:!0}):{}},Sr=t=>er()[t];export{T as ClientApi,J as addArgTypes,q as addArgTypesEnhancer,H as addArgs,W as addArgsEnhancer,Q as addDecorator,B as addLoader,U as addParameters,K as addStepRunner,Sr as getQueryParam,er as getQueryParams,X as setGlobalRender};
