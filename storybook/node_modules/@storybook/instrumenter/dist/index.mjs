import{addons as j}from"@storybook/addons";import{once as D,logger as k}from"@storybook/client-logger";import{FORCE_REMOUNT as T,IGNORED_EXCEPTION as P,SET_CURRENT_STORY as L,STORY_RENDER_PHASE_CHANGED as U}from"@storybook/core-events";import h from"global";var x=(l=>(l.DONE="done",l.ERROR="error",l.ACTIVE="active",l.WAITING="waiting",l))(x||{});var y={CALL:"storybook/instrumenter/call",SYNC:"storybook/instrumenter/sync",START:"storybook/instrumenter/start",BACK:"storybook/instrumenter/back",GOTO:"storybook/instrumenter/goto",NEXT:"storybook/instrumenter/next",END:"storybook/instrumenter/end"},A=h.FEATURES?.interactionsDebugger!==!0,C={debugger:!A,start:!1,back:!1,goto:!1,next:!1,end:!1},E=new Error("This function ran after the play function completed. Did you forget to `await` it?"),N=u=>Object.prototype.toString.call(u)==="[object Object]",B=u=>Object.prototype.toString.call(u)==="[object Module]",M=u=>{if(!N(u)&&!B(u))return!1;if(u.constructor===void 0)return!0;let s=u.constructor.prototype;return!(!N(s)||Object.prototype.hasOwnProperty.call(s,"isPrototypeOf")===!1)},Y=u=>{try{return new u.constructor}catch{return{}}},m=()=>({renderPhase:void 0,isDebugging:!1,isPlaying:!1,isLocked:!1,cursor:0,calls:[],shadowCalls:[],callRefsByResult:new Map,chainedCallIds:new Set,ancestors:[],playUntil:void 0,resolvers:{},syncTimeout:void 0}),w=(u,s=!1)=>{let t=(s?u.shadowCalls:u.calls).filter(l=>l.retain);if(!t.length)return;let d=new Map(Array.from(u.callRefsByResult.entries()).filter(([,l])=>l.retain));return{cursor:t.length,calls:t,callRefsByResult:d}},O=class{constructor(){this.initialized=!1;this.channel=j.getChannel(),this.state=h.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__||{};let s=({storyId:n,isPlaying:r=!0,isDebugging:e=!1})=>{let a=this.getState(n);this.setState(n,{...m(),...w(a,e),shadowCalls:e?a.shadowCalls:[],chainedCallIds:e?a.chainedCallIds:new Set,playUntil:e?a.playUntil:void 0,isPlaying:r,isDebugging:e}),this.sync(n)};this.channel.on(T,s),this.channel.on(U,({storyId:n,newPhase:r})=>{let{isDebugging:e}=this.getState(n);this.setState(n,{renderPhase:r}),r==="preparing"&&e&&s({storyId:n}),r==="playing"&&s({storyId:n,isDebugging:e}),r==="played"&&this.setState(n,{isLocked:!1,isPlaying:!1,isDebugging:!1}),r==="errored"&&this.setState(n,{isLocked:!1,isPlaying:!1})}),this.channel.on(L,()=>{this.initialized?this.cleanup():this.initialized=!0});let t=({storyId:n,playUntil:r})=>{this.getState(n).isDebugging||this.setState(n,({calls:a})=>({calls:[],shadowCalls:a.map(i=>({...i,status:"waiting"})),isDebugging:!0}));let e=this.getLog(n);this.setState(n,({shadowCalls:a})=>{if(r||!e.length)return{playUntil:r};let i=a.findIndex(f=>f.id===e[0].callId);return{playUntil:a.slice(0,i).filter(f=>f.interceptable&&!f.ancestors.length).slice(-1)[0]?.id}}),this.channel.emit(T,{storyId:n,isDebugging:!0})},d=({storyId:n})=>{let r=this.getLog(n).filter(a=>!a.ancestors.length),e=r.reduceRight((a,i,f)=>a>=0||i.status==="waiting"?a:f,-1);t({storyId:n,playUntil:r[e-1]?.callId})},l=({storyId:n,callId:r})=>{let{calls:e,shadowCalls:a,resolvers:i}=this.getState(n),f=e.find(({id:_})=>_===r),g=a.find(({id:_})=>_===r);if(!f&&g&&Object.values(i).length>0){let _=this.getLog(n).find(p=>p.status==="waiting")?.callId;g.id!==_&&this.setState(n,{playUntil:g.id}),Object.values(i).forEach(p=>p())}else t({storyId:n,playUntil:r})},o=({storyId:n})=>{let{resolvers:r}=this.getState(n);if(Object.values(r).length>0)Object.values(r).forEach(e=>e());else{let e=this.getLog(n).find(a=>a.status==="waiting")?.callId;e?t({storyId:n,playUntil:e}):c({storyId:n})}},c=({storyId:n})=>{this.setState(n,{playUntil:void 0,isDebugging:!1}),Object.values(this.getState(n).resolvers).forEach(r=>r())};this.channel.on(y.START,t),this.channel.on(y.BACK,d),this.channel.on(y.GOTO,l),this.channel.on(y.NEXT,o),this.channel.on(y.END,c)}getState(s){return this.state[s]||m()}setState(s,t){let d=this.getState(s),l=typeof t=="function"?t(d):t;this.state={...this.state,[s]:{...d,...l}},h.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}cleanup(){this.state=Object.entries(this.state).reduce((t,[d,l])=>{let o=w(l);return o&&(t[d]=Object.assign(m(),o)),t},{});let s={controlStates:C,logItems:[]};this.channel.emit(y.SYNC,s),h.window.parent.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER_STATE__=this.state}getLog(s){let{calls:t,shadowCalls:d}=this.getState(s),l=[...d];t.forEach((c,n)=>{l[n]=c});let o=new Set;return l.reduceRight((c,n)=>(n.args.forEach(r=>{r?.__callId__&&o.add(r.__callId__)}),n.path.forEach(r=>{r.__callId__&&o.add(r.__callId__)}),(n.interceptable||n.exception)&&!o.has(n.id)&&(c.unshift({callId:n.id,status:n.status,ancestors:n.ancestors}),o.add(n.id)),c),[])}instrument(s,t){if(!M(s))return s;let{mutate:d=!1,path:l=[]}=t;return Object.keys(s).reduce((o,c)=>{let n=s[c];return typeof n!="function"?(o[c]=this.instrument(n,{...t,path:l.concat(c)}),o):typeof n.__originalFn__=="function"?(o[c]=n,o):(o[c]=(...r)=>this.track(c,n,r,t),o[c].__originalFn__=n,Object.defineProperty(o[c],"name",{value:c,writable:!1}),Object.keys(n).length>0&&Object.assign(o[c],this.instrument({...n},{...t,path:l.concat(c)})),o)},d?s:Y(s))}track(s,t,d,l){let o=d?.[0]?.__storyId__||h.window.__STORYBOOK_PREVIEW__?.urlStore?.selection?.storyId,{cursor:c,ancestors:n}=this.getState(o);this.setState(o,{cursor:c+1});let r=`${n.slice(-1)[0]||o} [${c}] ${s}`,{path:e=[],intercept:a=!1,retain:i=!1}=l,f=typeof a=="function"?a(s,e):a,g={id:r,cursor:c,storyId:o,ancestors:n,path:e,method:s,args:d,interceptable:f,retain:i},p=(f&&!n.length?this.intercept:this.invoke).call(this,t,g,l);return this.instrument(p,{...l,mutate:!0,path:[{__callId__:g.id}]})}intercept(s,t,d){let{chainedCallIds:l,isDebugging:o,playUntil:c}=this.getState(t.storyId),n=l.has(t.id);return!o||n||c?(c===t.id&&this.setState(t.storyId,{playUntil:void 0}),this.invoke(s,t,d)):new Promise(r=>{this.setState(t.storyId,({resolvers:e})=>({isLocked:!1,resolvers:{...e,[t.id]:r}}))}).then(()=>(this.setState(t.storyId,r=>{let{[t.id]:e,...a}=r.resolvers;return{isLocked:!0,resolvers:a}}),this.invoke(s,t,d)))}invoke(s,t,d){let{callRefsByResult:l,renderPhase:o}=this.getState(t.storyId),c=e=>{if(l.has(e))return l.get(e);if(e instanceof Array)return e.map(c);if(e instanceof Date)return{__date__:{value:e.toISOString()}};if(e instanceof Error){let{name:a,message:i,stack:f}=e;return{__error__:{name:a,message:i,stack:f}}}if(e instanceof RegExp){let{flags:a,source:i}=e;return{__regexp__:{flags:a,source:i}}}if(e instanceof h.window.HTMLElement){let{prefix:a,localName:i,id:f,classList:g,innerText:_}=e,p=Array.from(g);return{__element__:{prefix:a,localName:i,id:f,classNames:p,innerText:_}}}return typeof e=="function"?{__function__:{name:e.name}}:typeof e=="symbol"?{__symbol__:{description:e.description}}:typeof e=="object"&&e?.constructor?.name&&e?.constructor?.name!=="Object"?{__class__:{name:e.constructor.name}}:Object.prototype.toString.call(e)==="[object Object]"?Object.fromEntries(Object.entries(e).map(([a,i])=>[a,c(i)])):e},n={...t,args:t.args.map(c)};t.path.forEach(e=>{e?.__callId__&&this.setState(t.storyId,({chainedCallIds:a})=>({chainedCallIds:new Set(Array.from(a).concat(e.__callId__))}))});let r=e=>{if(e instanceof Error){let{name:a,message:i,stack:f,callId:g=t.id}=e,_={name:a,message:i,stack:f,callId:g};if(this.update({...n,status:"error",exception:_}),this.setState(t.storyId,p=>({callRefsByResult:new Map([...Array.from(p.callRefsByResult.entries()),[e,{__callId__:t.id,retain:t.retain}]])})),t.ancestors.length)throw Object.prototype.hasOwnProperty.call(e,"callId")||Object.defineProperty(e,"callId",{value:t.id}),e;if(e!==E)throw k.warn(e),P}throw e};try{if(o==="played"&&!t.retain)throw E;let a=(d.getArgs?d.getArgs(t,this.getState(t.storyId)):t.args).map(f=>typeof f!="function"||Object.keys(f).length?f:(...g)=>{let{cursor:_,ancestors:p}=this.getState(t.storyId);this.setState(t.storyId,{cursor:0,ancestors:[...p,t.id]});let I=()=>this.setState(t.storyId,{cursor:_,ancestors:p}),b=!1;try{let S=f(...g);return S instanceof Promise?(b=!0,S.finally(I)):S}finally{b||I()}}),i=s(...a);return i&&["object","function","symbol"].includes(typeof i)&&this.setState(t.storyId,f=>({callRefsByResult:new Map([...Array.from(f.callRefsByResult.entries()),[i,{__callId__:t.id,retain:t.retain}]])})),this.update({...n,status:i instanceof Promise?"active":"done"}),i instanceof Promise?i.then(f=>(this.update({...n,status:"done"}),f),r):i}catch(e){return r(e)}}update(s){this.channel.emit(y.CALL,s),this.setState(s.storyId,({calls:t})=>{let d=t.concat(s).reduce((l,o)=>Object.assign(l,{[o.id]:o}),{});return{calls:Object.values(d).sort((l,o)=>l.id.localeCompare(o.id,void 0,{numeric:!0}))}}),this.sync(s.storyId)}sync(s){let t=()=>{let{isLocked:d,isPlaying:l}=this.getState(s),o=this.getLog(s),c=o.filter(({ancestors:i})=>!i.length).find(i=>i.status==="waiting")?.callId,n=o.some(i=>i.status==="active");if(A||d||n||o.length===0){let i={controlStates:C,logItems:o};this.channel.emit(y.SYNC,i);return}let r=o.some(i=>["done","error"].includes(i.status)),a={controlStates:{debugger:!0,start:r,back:r,goto:!0,next:l,end:l},logItems:o,pausedAt:c};this.channel.emit(y.SYNC,a)};this.setState(s,({syncTimeout:d})=>(clearTimeout(d),{syncTimeout:setTimeout(t,0)}))}};function G(u,s={}){try{let t=!1,d=!1;return h.window.location?.search?.includes("instrument=true")?t=!0:h.window.location?.search?.includes("instrument=false")&&(d=!0),h.window.parent===h.window&&!t||d?u:(h.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__||(h.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__=new O),h.window.__STORYBOOK_ADDON_INTERACTIONS_INSTRUMENTER__.instrument(u,s))}catch(t){return D.warn(t),u}}export{x as CallStates,y as EVENTS,G as instrument};
