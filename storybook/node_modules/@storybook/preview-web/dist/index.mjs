import{composeConfigs as lt}from"@storybook/store";import{dedent as B}from"ts-dedent";import b from"global";import{SynchronousPromise as q}from"synchronous-promise";import{CONFIG_ERROR as pe,FORCE_REMOUNT as me,FORCE_RE_RENDER as Se,GLOBALS_UPDATED as we,RESET_STORY_ARGS as ue,SET_GLOBALS as fe,STORY_ARGS_UPDATED as Ee,STORY_INDEX_INVALIDATED as Re,UPDATE_GLOBALS as ge,UPDATE_STORY_ARGS as be}from"@storybook/core-events";import{logger as I}from"@storybook/client-logger";import{addons as v}from"@storybook/addons";import{StoryStore as Te}from"@storybook/store";import H from"global";import{logger as le}from"@storybook/client-logger";import{STORY_RENDER_PHASE_CHANGED as V,STORY_RENDERED as ce,PLAY_FUNCTION_THREW_EXCEPTION as he}from"@storybook/core-events";var w=new Error("prepareAborted");var{AbortController:z}=H;function ye(o){try{let{name:e="Error",message:r=String(o),stack:t}=o;return{name:e,message:r,stack:t}}catch{return{name:"Error",message:String(o)}}}var R=class{constructor(e,r,t,n,s,i,d={autoplay:!0},l){this.channel=e;this.store=r;this.renderToScreen=t;this.callbacks=n;this.id=s;this.viewMode=i;this.renderOptions=d;this.type="story";this.notYetRendered=!0;this.disableKeyListeners=!1;this.teardownRender=()=>{};this.torndown=!1;this.abortController=new z,l&&(this.story=l,this.phase="preparing")}async runPhase(e,r,t){this.phase=r,this.channel.emit(V,{newPhase:this.phase,storyId:this.id}),t&&await t(),e.aborted&&(this.phase="aborted",this.channel.emit(V,{newPhase:this.phase,storyId:this.id}))}async prepare(){if(await this.runPhase(this.abortController.signal,"preparing",async()=>{this.story=await this.store.loadStory({storyId:this.id})}),this.abortController.signal.aborted)throw this.store.cleanupStory(this.story),w}isEqual(e){return!!(this.id===e.id&&this.story&&this.story===e.story)}isPreparing(){return["preparing"].includes(this.phase)}isPending(){return["rendering","playing"].includes(this.phase)}async renderToElement(e){return this.canvasElement=e,this.render({initial:!0,forceRemount:!0})}storyContext(){if(!this.story)throw new Error("Cannot call storyContext before preparing");return this.store.getStoryContext(this.story)}async render({initial:e=!1,forceRemount:r=!1}={}){let{canvasElement:t}=this;if(!this.story)throw new Error("cannot render when not prepared");if(!t)throw new Error("cannot render when canvasElement is unset");let{id:n,componentId:s,title:i,name:d,tags:l,applyLoaders:a,unboundStoryFn:A,playFunction:p}=this.story;r&&!e&&(this.cancelRender(),this.abortController=new z);let c=this.abortController.signal;try{let h;if(await this.runPhase(c,"loading",async()=>{h=await a({...this.storyContext(),viewMode:this.viewMode})}),c.aborted)return;let k={...h,...this.storyContext(),abortSignal:c,canvasElement:t},_={componentId:s,title:i,kind:i,id:n,name:d,story:d,tags:l,...this.callbacks,showError:m=>(this.phase="errored",this.callbacks.showError(m)),showException:m=>(this.phase="errored",this.callbacks.showException(m)),forceRemount:r||this.notYetRendered,storyContext:k,storyFn:()=>A(k),unboundStoryFn:A};if(await this.runPhase(c,"rendering",async()=>{let m=await this.renderToScreen(_,t);this.teardownRender=m||(()=>{})}),this.notYetRendered=!1,c.aborted)return;if(this.renderOptions.autoplay&&r&&p&&this.phase!=="errored"){this.disableKeyListeners=!0;try{await this.runPhase(c,"playing",async()=>{await p(_.storyContext)}),await this.runPhase(c,"played")}catch(m){if(le.error(m),await this.runPhase(c,"errored",async()=>{this.channel.emit(he,ye(m))}),this.story.parameters.throwPlayFunctionExceptions!==!1)throw m}if(this.disableKeyListeners=!1,c.aborted)return}await this.runPhase(c,"completed",async()=>this.channel.emit(ce,n))}catch(h){this.phase="errored",this.callbacks.showException(h)}}async rerender(){return this.render()}async remount(){return this.render({forceRemount:!0})}cancelRender(){this.abortController?.abort()}async teardown(){this.torndown=!0,this.cancelRender(),this.story&&this.store.cleanupStory(this.story);for(let e=0;e<3;e+=1){if(!this.isPending()){await this.teardownRender();return}await new Promise(r=>setTimeout(r,0))}H.window.location.reload(),await new Promise(()=>{})}};var{fetch:Pe}=b,Fe="./index.json",T=class{constructor(e=v.getChannel()){this.channel=e;this.storyRenders=[];b.FEATURES?.storyStoreV7&&v.hasServerChannel()&&(this.serverChannel=v.getServerChannel()),this.storyStore=new Te}initialize({getStoryIndex:e,importFn:r,getProjectAnnotations:t}){return this.getStoryIndex=e,this.importFn=r,this.setupListeners(),this.getProjectAnnotationsOrRenderError(t).then(n=>this.initializeWithProjectAnnotations(n))}setupListeners(){this.serverChannel?.on(Re,this.onStoryIndexChanged.bind(this)),this.channel.on(ge,this.onUpdateGlobals.bind(this)),this.channel.on(be,this.onUpdateArgs.bind(this)),this.channel.on(ue,this.onResetArgs.bind(this)),this.channel.on(Se,this.onForceReRender.bind(this)),this.channel.on(me,this.onForceRemount.bind(this))}getProjectAnnotationsOrRenderError(e){return q.resolve().then(e).then(r=>{if(this.renderToDOM=r.renderToDOM,!this.renderToDOM)throw new Error(B`
            Expected your framework's preset to export a \`renderToDOM\` field.

            Perhaps it needs to be upgraded for Storybook 6.4?

            More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#mainjs-framework-field
          `);return r}).catch(r=>{throw this.renderPreviewEntryError("Error reading preview.js:",r),r})}initializeWithProjectAnnotations(e){this.storyStore.setProjectAnnotations(e),this.setInitialGlobals();let r;if(b.FEATURES?.storyStoreV7)r=this.getStoryIndexFromServer();else{if(!this.getStoryIndex)throw new Error("No `getStoryIndex` passed defined in v6 mode");r=q.resolve().then(this.getStoryIndex)}return r.then(t=>this.initializeWithStoryIndex(t)).catch(t=>{throw this.renderPreviewEntryError("Error loading story index:",t),t})}async setInitialGlobals(){this.emitGlobals()}emitGlobals(){if(!this.storyStore.globals||!this.storyStore.projectAnnotations)throw new Error("Cannot emit before initialization");this.channel.emit(fe,{globals:this.storyStore.globals.get()||{},globalTypes:this.storyStore.projectAnnotations.globalTypes||{}})}async getStoryIndexFromServer(){let e=await Pe(Fe);if(e.status===200)return e.json();throw new Error(await e.text())}initializeWithStoryIndex(e){if(!this.importFn)throw new Error("Cannot call initializeWithStoryIndex before initialization");return this.storyStore.initialize({storyIndex:e,importFn:this.importFn,cache:!b.FEATURES?.storyStoreV7})}async onGetProjectAnnotationsChanged({getProjectAnnotations:e}){delete this.previewEntryError;let r=await this.getProjectAnnotationsOrRenderError(e);if(!this.storyStore.projectAnnotations){await this.initializeWithProjectAnnotations(r);return}await this.storyStore.setProjectAnnotations(r),this.emitGlobals()}async onStoryIndexChanged(){if(delete this.previewEntryError,!!this.storyStore.projectAnnotations)try{let e=await this.getStoryIndexFromServer();this.storyStore.storyIndex||await this.initializeWithStoryIndex(e),await this.onStoriesChanged({storyIndex:e})}catch(e){throw this.renderPreviewEntryError("Error loading story index:",e),e}}async onStoriesChanged({importFn:e,storyIndex:r}){await this.storyStore.onStoriesChanged({importFn:e,storyIndex:r})}async onUpdateGlobals({globals:e}){if(!this.storyStore.globals)throw new Error("Cannot call onUpdateGlobals before initialization");this.storyStore.globals.update(e),await Promise.all(this.storyRenders.map(r=>r.rerender())),this.channel.emit(we,{globals:this.storyStore.globals.get(),initialGlobals:this.storyStore.globals.initialGlobals})}async onUpdateArgs({storyId:e,updatedArgs:r}){this.storyStore.args.update(e,r),await Promise.all(this.storyRenders.filter(t=>t.id===e).map(t=>t.rerender())),this.channel.emit(Ee,{storyId:e,args:this.storyStore.args.get(e)})}async onResetArgs({storyId:e,argNames:r}){let n=this.storyRenders.find(d=>d.id===e)?.story||await this.storyStore.loadStory({storyId:e}),i=(r||[...new Set([...Object.keys(n.initialArgs),...Object.keys(this.storyStore.args.get(e))])]).reduce((d,l)=>(d[l]=n.initialArgs[l],d),{});await this.onUpdateArgs({storyId:e,updatedArgs:i})}async onForceReRender(){await Promise.all(this.storyRenders.map(e=>e.rerender()))}async onForceRemount({storyId:e}){await Promise.all(this.storyRenders.filter(r=>r.id===e).map(r=>r.remount()))}renderStoryToElement(e,r,t){if(!this.renderToDOM)throw new Error("Cannot call renderStoryToElement before initialization");let n=new R(this.channel,this.storyStore,this.renderToDOM,this.inlineStoryCallbacks(e.id),e.id,"docs",t,e);return n.renderToElement(r),this.storyRenders.push(n),async()=>{await this.teardownRender(n)}}async teardownRender(e,{viewModeChanged:r}={}){this.storyRenders=this.storyRenders.filter(t=>t!==e),await e?.teardown?.({viewModeChanged:r})}async extract(e){if(this.previewEntryError)throw this.previewEntryError;if(!this.storyStore.projectAnnotations)throw new Error(B`Failed to initialize Storybook.

      Do you have an error in your \`preview.js\`? Check your Storybook's browser console for errors.`);return b.FEATURES?.storyStoreV7&&await this.storyStore.cacheAllCSFFiles(),this.storyStore.extract(e)}inlineStoryCallbacks(e){return{showMain:()=>{},showError:r=>I.error(`Error rendering docs story (${e})`,r),showException:r=>I.error(`Error rendering docs story (${e})`,r)}}renderPreviewEntryError(e,r){this.previewEntryError=r,I.error(e),I.error(r),this.channel.emit(pe,r)}};import{dedent as W}from"ts-dedent";import C from"global";import{CURRENT_STORY_WAS_SET as oe,PRELOAD_ENTRIES as Ve,PREVIEW_KEYDOWN as ze,SET_CURRENT_STORY as He,SET_INDEX as ne,STORY_ARGS_UPDATED as Be,STORY_CHANGED as qe,STORY_ERRORED as Ke,STORY_MISSING as se,STORY_PREPARED as Qe,STORY_RENDER_PHASE_CHANGED as ie,STORY_SPECIFIED as Xe,STORY_THREW_EXCEPTION as Ze,STORY_UNCHANGED as Je,UPDATE_QUERY_PARAMS as er}from"@storybook/core-events";import{logger as g}from"@storybook/client-logger";import Me from"global";import j from"qs";import xe from"qs";import{dedent as Ce}from"ts-dedent";import{once as Ae}from"@storybook/client-logger";import ke from"lodash/isPlainObject";var K=/^[a-zA-Z0-9 _-]*$/,Q=/^-?[0-9]+(\.[0-9]+)?$/,_e=/^#([a-f0-9]{3,4}|[a-f0-9]{6}|[a-f0-9]{8})$/i,X=/^(rgba?|hsla?)\(([0-9]{1,3}),\s?([0-9]{1,3})%?,\s?([0-9]{1,3})%?,?\s?([0-9](\.[0-9]{1,2})?)?\)$/i,O=(o="",e)=>o===null||o===""||!K.test(o)?!1:e==null||e instanceof Date||typeof e=="number"||typeof e=="boolean"?!0:typeof e=="string"?K.test(e)||Q.test(e)||_e.test(e)||X.test(e):Array.isArray(e)?e.every(r=>O(o,r)):ke(e)?Object.entries(e).every(([r,t])=>O(r,t)):!1,Ie={delimiter:";",allowDots:!0,allowSparse:!0,decoder(o,e,r,t){if(t==="value"&&o.startsWith("!")){if(o==="!undefined")return;if(o==="!null")return null;if(o.startsWith("!date(")&&o.endsWith(")"))return new Date(o.slice(6,-1));if(o.startsWith("!hex(")&&o.endsWith(")"))return`#${o.slice(5,-1)}`;let n=o.slice(1).match(X);if(n)return o.startsWith("!rgba")?`${n[1]}(${n[2]}, ${n[3]}, ${n[4]}, ${n[5]})`:o.startsWith("!hsla")?`${n[1]}(${n[2]}, ${n[3]}%, ${n[4]}%, ${n[5]})`:o.startsWith("!rgb")?`${n[1]}(${n[2]}, ${n[3]}, ${n[4]})`:`${n[1]}(${n[2]}, ${n[3]}%, ${n[4]}%)`}return t==="value"&&Q.test(o)?Number(o):e(o,e,r)}},L=o=>{let e=o.split(";").map(r=>r.replace("=","~").replace(":","="));return Object.entries(xe.parse(e.join(";"),Ie)).reduce((r,[t,n])=>O(t,n)?Object.assign(r,{[t]:n}):(Ae.warn(Ce`
      Omitted potentially unsafe URL args.

      More info: https://storybook.js.org/docs/react/writing-stories/args#setting-args-through-the-url
    `),r),{})};var{history:Z,document:u}=Me;function De(o){let e=(o||"").match(/^\/story\/(.+)/);if(!e)throw new Error(`Invalid path '${o}',  must start with '/story/'`);return e[1]}var J=({selection:o,extraParams:e})=>{let{search:r=""}=u.location,{path:t,selectedKind:n,selectedStory:s,...i}=j.parse(r,{ignoreQueryPrefix:!0});return j.stringify({...i,...e,...o&&{id:o.storyId,viewMode:o.viewMode}},{encode:!1,addQueryPrefix:!0})},ve=o=>{if(!o)return;let e=J({selection:o}),{hash:r=""}=u.location;u.title=o.storyId,Z.replaceState({},"",`${u.location.pathname}${e}${r}`)},Oe=o=>o!=null&&typeof o=="object"&&Array.isArray(o)===!1,P=o=>{if(o!==void 0){if(typeof o=="string")return o;if(Array.isArray(o))return P(o[0]);if(Oe(o))return P(Object.values(o).filter(Boolean))}},Le=()=>{let o=j.parse(u.location.search,{ignoreQueryPrefix:!0}),e=typeof o.args=="string"?L(o.args):void 0,r=typeof o.globals=="string"?L(o.globals):void 0,t=P(o.viewMode);(typeof t!="string"||!t.match(/docs|story/))&&(t="story");let n=P(o.path),s=n?De(n):P(o.id);return s?{storySpecifier:s,args:e,globals:r,viewMode:t}:null},M=class{constructor(){this.selectionSpecifier=Le()}setSelection(e){this.selection=e,ve(this.selection)}setQueryParams(e){let r=J({extraParams:e}),{hash:t=""}=u.location;Z.replaceState({},"",`${u.location.pathname}${r}${t}`)}};import je from"global";import{logger as Ne}from"@storybook/client-logger";import Ge from"ansi-to-html";import{dedent as We}from"ts-dedent";import $e from"qs";var{document:y}=je,ee=100,N={centered:"sb-main-centered",fullscreen:"sb-main-fullscreen",padded:"sb-main-padded"},te=(s=>(s.MAIN="MAIN",s.NOPREVIEW="NOPREVIEW",s.PREPARING_STORY="PREPARING_STORY",s.PREPARING_DOCS="PREPARING_DOCS",s.ERROR="ERROR",s))(te||{}),G={PREPARING_STORY:"sb-show-preparing-story",PREPARING_DOCS:"sb-show-preparing-docs",MAIN:"sb-show-main",NOPREVIEW:"sb-show-nopreview",ERROR:"sb-show-errordisplay"},re=new Ge({escapeXML:!0}),D=class{constructor(){this.testing=!1;let{__SPECIAL_TEST_PARAMETER__:e}=$e.parse(y.location.search,{ignoreQueryPrefix:!0});switch(e){case"preparing-story":{this.showPreparingStory(),this.testing=!0;break}case"preparing-docs":{this.showPreparingDocs(),this.testing=!0;break}default:}}prepareForStory(e){return this.showStory(),this.applyLayout(e.parameters.layout),y.documentElement.scrollTop=0,y.documentElement.scrollLeft=0,this.storyRoot()}storyRoot(){return y.getElementById("storybook-root")}prepareForDocs(){return this.showMain(),this.showDocs(),this.applyLayout("fullscreen"),this.docsRoot()}docsRoot(){return y.getElementById("storybook-docs")}applyLayout(e="padded"){if(e==="none"){y.body.classList.remove(this.currentLayoutClass),this.currentLayoutClass=null;return}this.checkIfLayoutExists(e);let r=N[e];y.body.classList.remove(this.currentLayoutClass),y.body.classList.add(r),this.currentLayoutClass=r}checkIfLayoutExists(e){N[e]||Ne.warn(We`The desired layout: ${e} is not a valid option.
         The possible options are: ${Object.keys(N).join(", ")}, none.`)}showMode(e){clearTimeout(this.preparingTimeout),Object.keys(te).forEach(r=>{r===e?y.body.classList.add(G[r]):y.body.classList.remove(G[r])})}showErrorDisplay({message:e="",stack:r=""}){let t=e,n=r,s=e.split(`
`);s.length>1&&([t]=s,n=s.slice(1).join(`
`)),y.getElementById("error-message").innerHTML=re.toHtml(t),y.getElementById("error-stack").innerHTML=re.toHtml(n),this.showMode("ERROR")}showNoPreview(){this.testing||(this.showMode("NOPREVIEW"),this.storyRoot()?.setAttribute("hidden","true"),this.docsRoot()?.setAttribute("hidden","true"))}showPreparingStory({immediate:e=!1}={}){clearTimeout(this.preparingTimeout),e?this.showMode("PREPARING_STORY"):this.preparingTimeout=setTimeout(()=>this.showMode("PREPARING_STORY"),ee)}showPreparingDocs(){clearTimeout(this.preparingTimeout),this.preparingTimeout=setTimeout(()=>this.showMode("PREPARING_DOCS"),ee)}showMain(){this.showMode("MAIN")}showDocs(){this.storyRoot().setAttribute("hidden","true"),this.docsRoot().removeAttribute("hidden")}showStory(){this.docsRoot().setAttribute("hidden","true"),this.storyRoot().removeAttribute("hidden")}showStoryDuringRender(){y.body.classList.add(G.MAIN)}};import{DOCS_RENDERED as Ue}from"@storybook/core-events";var f=class{constructor(e,r,t,n,s=!0){this.channel=e;this.store=r;this.renderStoryToElement=t;this.storyIdByName=e=>{let r=this.nameToStoryId.get(e);if(r)return r;throw new Error(`No story found with that name: ${e}`)};this.componentStories=()=>this.componentStoriesValue;this.storyById=e=>{if(!e){if(!this.primaryStory)throw new Error("No primary story defined for docs entry. Did you forget to use `<Meta>`?");return this.primaryStory}let r=this.storyIdToCSFFile.get(e);if(!r)throw new Error(`Called \`storyById\` for story that was never loaded: ${e}`);return this.store.storyFromCSFFile({storyId:e,csfFile:r})};this.getStoryContext=e=>({...this.store.getStoryContext(e),viewMode:"docs"});this.loadStory=e=>this.store.loadStory({storyId:e});this.storyIdToCSFFile=new Map,this.exportToStoryId=new Map,this.nameToStoryId=new Map,this.componentStoriesValue=[],n.forEach((i,d)=>{this.referenceCSFFile(i,s||d===0)})}referenceCSFFile(e,r){Object.values(e.stories).forEach(t=>{if(this.storyIdToCSFFile.set(t.id,e),this.exportToStoryId.set(t.moduleExport,t.id),r){this.nameToStoryId.set(t.name,t.id);let n=this.storyById(t.id);this.componentStoriesValue.push(n),this.primaryStory||(this.primaryStory=n)}})}setMeta(e){}storyIdByModuleExport(e,r){let t=this.exportToStoryId.get(e);if(t)return t;throw new Error(`No story found with that export: ${e}`)}};var F=class{constructor(e,r,t){this.channel=e;this.store=r;this.entry=t;this.type="docs";this.torndown=!1;this.disableKeyListeners=!1;this.preparing=!1;this.id=t.id}isPreparing(){return this.preparing}async prepare(){this.preparing=!0;let{entryExports:e,csfFiles:r=[]}=await this.store.loadEntry(this.id);if(this.torndown)throw w;let{importPath:t,title:n}=this.entry,s=this.store.processCSFFileWithCache(e,t,n),i=Object.keys(s.stories)[0];this.story=this.store.storyFromCSFFile({storyId:i,csfFile:s}),this.csfFiles=[s,...r],this.preparing=!1}isEqual(e){return!!(this.id===e.id&&this.story&&this.story===e.story)}async renderToElement(e,r){if(!this.story||!this.csfFiles)throw new Error("Cannot render docs before preparing");let t=new f(this.channel,this.store,r,this.csfFiles,!0),{docs:n}=this.story.parameters||{};if(!n)throw new Error("Cannot render a story in viewMode=docs if `@storybook/addon-docs` is not installed");let s=await n.renderer(),{render:i}=s,d=async()=>{await new Promise(l=>i(t,n,e,l)),this.channel.emit(Ue,this.id)};return this.rerender=async()=>d(),this.teardownRender=async({viewModeChanged:l})=>{!l||!e||s.unmount(e)},d()}async teardown({viewModeChanged:e}={}){this.teardownRender?.({viewModeChanged:e}),this.torndown=!0}};import{DOCS_RENDERED as Ye}from"@storybook/core-events";var x=class{constructor(e,r,t){this.channel=e;this.store=r;this.entry=t;this.type="docs";this.torndown=!1;this.disableKeyListeners=!1;this.preparing=!1;this.id=t.id}isPreparing(){return this.preparing}async prepare(){this.preparing=!0;let{entryExports:e,csfFiles:r=[]}=await this.store.loadEntry(this.id);if(this.torndown)throw w;this.csfFiles=r,this.exports=e,this.preparing=!1}isEqual(e){return!!(this.id===e.id&&this.exports&&this.exports===e.exports)}async renderToElement(e,r){if(!this.exports||!this.csfFiles||!this.store.projectAnnotations)throw new Error("Cannot render docs before preparing");let t=new f(this.channel,this.store,r,this.csfFiles,!1),{docs:n}=this.store.projectAnnotations.parameters||{};if(!n)throw new Error("Cannot render a story in viewMode=docs if `@storybook/addon-docs` is not installed");let s={...n,page:this.exports.default},i=await n.renderer(),{render:d}=i,l=async()=>{await new Promise(a=>d(t,s,e,a)),this.channel.emit(Ye,this.id)};return this.rerender=async()=>l(),this.teardownRender=async({viewModeChanged:a}={})=>{!a||!e||(i.unmount(e),this.torndown=!0)},l()}async teardown({viewModeChanged:e}={}){this.teardownRender?.({viewModeChanged:e}),this.torndown=!0}};var{window:rr}=C;function tr(o){let e=o.target;return/input|textarea/i.test(e.tagName)||e.getAttribute("contenteditable")!==null}function $(o){return o.type==="story"}var U=class extends T{constructor(){super();this.view=new D,this.urlStore=new M}setupListeners(){super.setupListeners(),rr.onkeydown=this.onKeydown.bind(this),this.channel.on(He,this.onSetCurrentStory.bind(this)),this.channel.on(er,this.onUpdateQueryParams.bind(this)),this.channel.on(Ve,this.onPreloadStories.bind(this))}initializeWithProjectAnnotations(r){return super.initializeWithProjectAnnotations(r).then(()=>this.setInitialGlobals())}async setInitialGlobals(){if(!this.storyStore.globals)throw new Error("Cannot call setInitialGlobals before initialization");let{globals:r}=this.urlStore.selectionSpecifier||{};r&&this.storyStore.globals.updateFromPersisted(r),this.emitGlobals()}initializeWithStoryIndex(r){return super.initializeWithStoryIndex(r).then(()=>(C.FEATURES?.storyStoreV7||this.channel.emit(ne,this.storyStore.getSetIndexPayload()),this.selectSpecifiedStory()))}async selectSpecifiedStory(){if(!this.storyStore.storyIndex)throw new Error("Cannot call selectSpecifiedStory before initialization");if(!this.urlStore.selectionSpecifier){this.renderMissingStory();return}let{storySpecifier:r,args:t}=this.urlStore.selectionSpecifier,n=this.storyStore.storyIndex.entryFromSpecifier(r);if(!n){r==="*"?this.renderStoryLoadingException(r,new Error(W`
            Couldn't find any stories in your Storybook.
            - Please check your stories field of your main.js config.
            - Also check the browser console and terminal for error messages.
          `)):this.renderStoryLoadingException(r,new Error(W`
            Couldn't find story matching '${r}'.
            - Are you sure a story with that id exists?
            - Please check your stories field of your main.js config.
            - Also check the browser console and terminal for error messages.
          `));return}let{id:s,type:i}=n;this.urlStore.setSelection({storyId:s,viewMode:i}),this.channel.emit(Xe,this.urlStore.selection),this.channel.emit(oe,this.urlStore.selection),await this.renderSelection({persistedArgs:t})}async onGetProjectAnnotationsChanged({getProjectAnnotations:r}){await super.onGetProjectAnnotationsChanged({getProjectAnnotations:r}),this.urlStore.selection&&this.renderSelection()}async onStoriesChanged({importFn:r,storyIndex:t}){await super.onStoriesChanged({importFn:r,storyIndex:t}),C.FEATURES?.storyStoreV7||this.channel.emit(ne,await this.storyStore.getSetIndexPayload()),this.urlStore.selection?await this.renderSelection():await this.selectSpecifiedStory()}onKeydown(r){if(!this.storyRenders.find(t=>t.disableKeyListeners)&&!tr(r)){let{altKey:t,ctrlKey:n,metaKey:s,shiftKey:i,key:d,code:l,keyCode:a}=r;this.channel.emit(ze,{event:{altKey:t,ctrlKey:n,metaKey:s,shiftKey:i,key:d,code:l,keyCode:a}})}}async onSetCurrentStory(r){await this.storyStore.initializationPromise,this.urlStore.setSelection({viewMode:"story",...r}),this.channel.emit(oe,this.urlStore.selection),this.renderSelection()}onUpdateQueryParams(r){this.urlStore.setQueryParams(r)}async onUpdateGlobals({globals:r}){super.onUpdateGlobals({globals:r}),(this.currentRender instanceof x||this.currentRender instanceof F)&&await this.currentRender.rerender?.()}async onUpdateArgs({storyId:r,updatedArgs:t}){super.onUpdateArgs({storyId:r,updatedArgs:t})}async onPreloadStories({ids:r}){await Promise.allSettled(r.map(t=>this.storyStore.loadEntry(t)))}async renderSelection({persistedArgs:r}={}){let{renderToDOM:t}=this;if(!t)throw new Error("Cannot call renderSelection before initialization");let{selection:n}=this.urlStore;if(!n)throw new Error("Cannot call renderSelection as no selection was made");let{storyId:s}=n,i;try{i=await this.storyStore.storyIdToEntry(s)}catch(h){this.currentRender&&await this.teardownRender(this.currentRender),this.renderStoryLoadingException(s,h);return}let d=this.currentSelection?.storyId!==s,l=this.currentRender?.type!==i.type;i.type==="story"?this.view.showPreparingStory({immediate:l}):this.view.showPreparingDocs(),this.currentRender?.isPreparing()&&await this.teardownRender(this.currentRender);let a;i.type==="story"?a=new R(this.channel,this.storyStore,(...h)=>(this.view.showStoryDuringRender(),t(...h)),this.mainStoryCallbacks(s),s,"story"):i.standalone?a=new x(this.channel,this.storyStore,i):a=new F(this.channel,this.storyStore,i);let A=this.currentSelection;this.currentSelection=n;let p=this.currentRender;this.currentRender=a;try{await a.prepare()}catch(h){h!==w&&(p&&await this.teardownRender(p),this.renderStoryLoadingException(s,h));return}let c=!d&&p&&!a.isEqual(p);if(r&&$(a)){if(!a.story)throw new Error("Render has not been prepared!");this.storyStore.args.updateFromPersisted(a.story,r)}if(p&&!p.torndown&&!d&&!c&&!l){this.currentRender=p,this.channel.emit(Je,s),this.view.showMain();return}if(p&&await this.teardownRender(p,{viewModeChanged:l}),A&&(d||l)&&this.channel.emit(qe,s),$(a)){if(!a.story)throw new Error("Render has not been prepared!");let{parameters:h,initialArgs:k,argTypes:_,args:m}=this.storyStore.getStoryContext(a.story);C.FEATURES?.storyStoreV7&&this.channel.emit(Qe,{id:s,parameters:h,initialArgs:k,argTypes:_,args:m}),(c||r)&&this.channel.emit(Be,{storyId:s,args:m})}if($(a)){if(!a.story)throw new Error("Render has not been prepared!");this.storyRenders.push(a),this.currentRender.renderToElement(this.view.prepareForStory(a.story))}else this.currentRender.renderToElement(this.view.prepareForDocs(),this.renderStoryToElement.bind(this))}async teardownRender(r,{viewModeChanged:t=!1}={}){this.storyRenders=this.storyRenders.filter(n=>n!==r),await r?.teardown?.({viewModeChanged:t})}async extract(r){if(this.previewEntryError)throw this.previewEntryError;if(!this.storyStore.projectAnnotations)throw new Error(W`Failed to initialize Storybook.

      Do you have an error in your \`preview.js\`? Check your Storybook's browser console for errors.`);return C.FEATURES?.storyStoreV7&&await this.storyStore.cacheAllCSFFiles(),this.storyStore.extract(r)}mainStoryCallbacks(r){return{showMain:()=>this.view.showMain(),showError:t=>this.renderError(r,t),showException:t=>this.renderException(r,t)}}inlineStoryCallbacks(r){return{showMain:()=>{},showError:t=>g.error(`Error rendering docs story (${r})`,t),showException:t=>g.error(`Error rendering docs story (${r})`,t)}}renderPreviewEntryError(r,t){super.renderPreviewEntryError(r,t),this.view.showErrorDisplay(t)}renderMissingStory(){this.view.showNoPreview(),this.channel.emit(se)}renderStoryLoadingException(r,t){g.error(t),this.view.showErrorDisplay(t),this.channel.emit(se,r)}renderException(r,t){let{name:n="Error",message:s=String(t),stack:i}=t;this.channel.emit(Ze,{name:n,message:s,stack:i}),this.channel.emit(ie,{newPhase:"errored",storyId:r}),t.message?.startsWith("ignoredException")||(this.view.showErrorDisplay(t),g.error(`Error rendering story '${r}':`),g.error(t))}renderError(r,{title:t,description:n}){g.error(`Error rendering story ${t}: ${n}`),this.channel.emit(Ke,{title:t,description:n}),this.channel.emit(ie,{newPhase:"errored",storyId:r}),this.view.showErrorDisplay({message:t,stack:n})}};import or from"global";var{document:E}=or,nr=["application/javascript","application/ecmascript","application/x-ecmascript","application/x-javascript","text/ecmascript","text/javascript","text/javascript1.0","text/javascript1.1","text/javascript1.2","text/javascript1.3","text/javascript1.4","text/javascript1.5","text/jscript","text/livescript","text/x-ecmascript","text/x-javascript","module"],sr="script",ae="scripts-root";function Y(){let o=E.createEvent("Event");o.initEvent("DOMContentLoaded",!0,!0),E.dispatchEvent(o)}function ir(o,e,r){let t=E.createElement("script");t.type=o.type==="module"?"module":"text/javascript",o.src?(t.onload=e,t.onerror=e,t.src=o.src):t.textContent=o.innerText,r?r.appendChild(t):E.head.appendChild(t),o.parentNode.removeChild(o),o.src||e()}function de(o,e,r=0){o[r](()=>{r++,r===o.length?e():de(o,e,r)})}function ar(o){let e=E.getElementById(ae);e?e.innerHTML="":(e=E.createElement("div"),e.id=ae,E.body.appendChild(e));let r=Array.from(o.querySelectorAll(sr));if(r.length){let t=[];r.forEach(n=>{let s=n.getAttribute("type");(!s||nr.includes(s))&&t.push(i=>ir(n,i,e))}),t.length&&de(t,Y,void 0)}else Y()}export{f as DocsContext,T as Preview,U as PreviewWeb,lt as composeConfigs,Y as simulateDOMContentLoaded,ar as simulatePageLoad};
